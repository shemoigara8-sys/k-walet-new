<!DOCTYPE html>
<html>
<head>
  <title>K Wallet Dashboard</title>
</head>
<body>
  <h2>K Wallet Dashboard</h2>

  <p><b>User:</b> <span id="userEmail"></span></p>
  <p><b>Balance:</b> KSh <span id="balance">0</span></p>

  <h3>Add Money</h3>
  <input type="number" id="addAmount" placeholder="Amount">
  <button id="addBtn">Add</button>

  <h3>Send Money</h3>
  <input type="email" id="receiverEmail" placeholder="Receiver Email"><br><br>
  <input type="number" id="sendAmount" placeholder="Amount">
  <button id="sendBtn">Send</button>

  <br><br>
  <button id="logoutBtn">Logout</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAN10LcAxOI4UAAmT8529U6WxVMmpfDyy4",
  authDomain: "k-wallet-8f896.firebaseapp.com",
  projectId: "k-wallet-8f896",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUserUID = null;

// ðŸ” Check login state
onAuthStateChanged(auth, (user) => {
  if (user) {
    // user is logged in â€” stay on dashboard
    console.log("User logged in:", user.email);
  } else {
    // user not logged in â€” send to login
    window.location.href = "login.html";
  }
});

// ðŸ’° Load Balance
async function loadBalance() {
  const docRef = doc(db, "users", currentUserUID);
  const docSnap = await getDoc(docRef);
  if (docSnap.exists()) {
    document.getElementById("balance").innerText = docSnap.data().balance;
  }
}

// âž• Add Money
document.getElementById("addBtn").addEventListener("click", async () => {
  const amount = Number(document.getElementById("addAmount").value);
  const ref = doc(db, "users", currentUserUID);
  const snap = await getDoc(ref);
  let balance = snap.data().balance;

  await updateDoc(ref, { balance: balance + amount });
  loadBalance();
});

// ðŸ’¸ Send Money
document.getElementById("sendBtn").addEventListener("click", async () => {
  const receiverEmail = document.getElementById("receiverEmail").value;
  const amount = Number(document.getElementById("sendAmount").value);

  const senderRef = doc(db, "users", currentUserUID);
  const senderSnap = await getDoc(senderRef);
  let senderBalance = senderSnap.data().balance;

  if (senderBalance < amount) {
    alert("Not enough balance");
    return;
  }

  const q = query(collection(db, "users"), where("email", "==", receiverEmail));
  const querySnap = await getDocs(q);

  if (querySnap.empty) {
    alert("Receiver not found");
    return;
  }

  const receiverDoc = querySnap.docs[0];
  const receiverRef = doc(db, "users", receiverDoc.id);
  let receiverBalance = receiverDoc.data().balance;

  await updateDoc(senderRef, { balance: senderBalance - amount });
  await updateDoc(receiverRef, { balance: receiverBalance + amount });

  alert("Money Sent!");
  loadBalance();
});

// ðŸšª Logout
document.getElementById("logoutBtn").addEventListener("click", () => {
  signOut(auth);
});
</script>

</body>
</html>
