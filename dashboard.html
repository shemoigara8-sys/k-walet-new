<!DOCTYPE html>
<html>
<head>
  <title>K Wallet Dashboard</title>
</head>
<body>

  <h2>K Wallet Dashboard</h2>

  <p><b>User:</b> <span id="userEmail"></span></p>
  <p><b>Balance:</b> KSh <span id="balance">0</span></p>

  <h3>Add Money</h3>
  <input type="number" id="addAmount" placeholder="Amount">
  <button id="addBtn">Add</button>

  <h3>Send Money</h3>
  <input type="email" id="receiverEmail" placeholder="Receiver Email"><br><br>
  <input type="number" id="sendAmount" placeholder="Amount">
  <button id="sendBtn">Send</button>

  <br><br>
  <button id="logoutBtn">Logout</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getAuth, 
    onAuthStateChanged, 
    signOut 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { 
    getFirestore, 
    doc, 
    getDoc, 
    updateDoc, 
    collection, 
    query, 
    where, 
    getDocs 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ðŸ”¥ Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyAN10LcAxOI4UAAmT8529U6WxVMmpfDyy4",
    authDomain: "k-wallet-8f896.firebaseapp.com",
    projectId: "k-wallet-8f896",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUserUID = null;

  // ðŸ” Check login
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUserUID = user.uid;
      document.getElementById("userEmail").innerText = user.email;
      await loadBalance();
    } else {
      window.location.replace("login.html");
    }
  });

  // ðŸ’° Load balance
  async function loadBalance() {
    const ref = doc(db, "users", currentUserUID);
    const snap = await getDoc(ref);
    if (snap.exists()) {
      document.getElementById("balance").innerText = snap.data().balance;
    }
  }

  // âž• Add money
  document.getElementById("addBtn").addEventListener("click", async () => {
    const amount = Number(document.getElementById("addAmount").value);
    if (amount <= 0) {
      alert("Enter a valid amount");
      return;
    }

    const ref = doc(db, "users", currentUserUID);
    const snap = await getDoc(ref);
    const balance = snap.data().balance;

    await updateDoc(ref, { balance: balance + amount });
    loadBalance();
  });

  // ðŸ’¸ Send money
  document.getElementById("sendBtn").addEventListener("click", async () => {
    const receiverEmail = document.getElementById("receiverEmail").value;
    const amount = Number(document.getElementById("sendAmount").value);

    if (amount <= 0) {
      alert("Enter a valid amount");
      return;
    }

    const senderRef = doc(db, "users", currentUserUID);
    const senderSnap = await getDoc(senderRef);
    const senderBalance = senderSnap.data().balance;

    if (senderBalance < amount) {
      alert("Not enough balance");
      return;
    }

    const q = query(
      collection(db, "users"),
      where("email", "==", receiverEmail)
    );
    const querySnap = await getDocs(q);

    if (querySnap.empty) {
      alert("Receiver not found");
      return;
    }

    const receiverDoc = querySnap.docs[0];
    const receiverRef = doc(db, "users", receiverDoc.id);
    const receiverBalance = receiverDoc.data().balance;

    await updateDoc(senderRef, { balance: senderBalance - amount });
    await updateDoc(receiverRef, { balance: receiverBalance + amount });

    alert("Money Sent!");
    loadBalance();
  });

  // ðŸšª Logout
  document.getElementById("logoutBtn").addEventListener("click", () => {
    signOut(auth);
  });
</script>

</body>
</html>
