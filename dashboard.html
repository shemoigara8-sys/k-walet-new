<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>K Wallet Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a7c3a">

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Arial;background:#f4f6f8;color:#111}

/* Loader */
#loader{
position:fixed;inset:0;
display:flex;align-items:center;justify-content:center;
font-weight:bold;background:#f4f6f8;
}

/* PIN LOCK */
#pinLock{
position:fixed;inset:0;
background:#f4f6f8;
display:flex;align-items:center;justify-content:center;
flex-direction:column;z-index:999;
}

/* Topbar */
.topbar{
background:#0a7c3a;color:#fff;
padding:15px 25px;
display:flex;justify-content:space-between;
}

.logout{
background:#fff;color:#0a7c3a;
border:none;padding:8px 15px;
border-radius:6px;font-weight:bold;cursor:pointer;
}

.container{max-width:1000px;margin:30px auto;padding:0 20px}

.user-card{
background:linear-gradient(135deg,#0a7c3a,#0c5f2a);
color:#fff;padding:25px;border-radius:16px;margin-bottom:25px;
}

.balance{font-size:36px;font-weight:bold;margin-top:10px}

.grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
gap:20px;
}

.card{
background:#fff;padding:20px;
border-radius:14px;
box-shadow:0 6px 15px rgba(0,0,0,.08);
}

.card h3{margin-bottom:15px;color:#0a7c3a}

input{
width:100%;padding:12px;margin-bottom:12px;
border-radius:8px;border:1px solid #ccc;
}

.btn{
width:100%;background:#0a7c3a;color:#fff;
border:none;padding:12px;border-radius:8px;
font-weight:bold;cursor:pointer;
}

.tx-list li{
padding:10px 0;
border-bottom:1px solid #eee;
}
</style>
</head>

<body style="display:none;">

<!-- Loader -->
<div id="loader">Loading dashboard...</div>

<!-- PIN LOCK -->
<div id="pinLock">
<h2>K Wallet Security</h2>

<input type="password"
id="pinInput"
placeholder="Enter 4-digit PIN"
maxlength="4">

<button class="btn" id="unlockBtn">
Unlock Wallet
</button>
</div>

<!-- APP -->
<div id="app" style="display:none;">

<div class="topbar">
<h2>K Wallet</h2>
<button class="logout" id="logoutBtn">Logout</button>
</div>

<div class="container">

<div class="user-card">
<p>Logged in as</p>
<strong id="userEmail"></strong>
<div class="balance">KSh <span id="balance">0</span></div>
</div>

<div class="grid">

<!-- Add Money -->
<div class="card">
<h3>âž• Add Money</h3>
<input type="number" id="addAmount" placeholder="Amount">
<button class="btn" id="addBtn">Add Money</button>
</div>

<!-- Send Money -->
<div class="card">
<h3>ðŸ’¸ Send Money</h3>
<input type="email" id="receiverEmail" placeholder="Receiver Email">
<input type="number" id="sendAmount" placeholder="Amount">
<button class="btn" id="sendBtn">Send Money</button>
</div>

</div>

<!-- Transactions -->
<div class="card" style="margin-top:25px;">
<h3>ðŸ“œ Transaction History</h3>
<ul id="txList" class="tx-list"></ul>
</div>

</div>
</div>

<!-- FIREBASE + LOGIC -->
<script type="module">

import { initializeApp }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getAuth,onAuthStateChanged,signOut
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
getFirestore,doc,getDoc,updateDoc,
collection,query,where,orderBy,
getDocs,addDoc,serverTimestamp
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* Firebase config */
const firebaseConfig = {
apiKey:"AIzaSyAN10LcAxOI4UAAmT8529U6WxVMmpfDyy4",
authDomain: "k-wallet-8f896.firebaseapp.com",
projectId: "k-wallet-8f896"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* Elements */
const loader = document.getElementById("loader");
const appUI = document.getElementById("app");

const userEmail = document.getElementById("userEmail");
const balanceEl = document.getElementById("balance");

const addBtn = document.getElementById("addBtn");
const sendBtn = document.getElementById("sendBtn");
const logoutBtn = document.getElementById("logoutBtn");

const pinLock = document.getElementById("pinLock");
const unlockBtn = document.getElementById("unlockBtn");

let currentUID = null;

/* AUTH */
onAuthStateChanged(auth, async (user) => {

if(!user){
window.location.replace("login.html");
return;
}

document.body.style.display="block";
loader.style.display="none";
appUI.style.display="block";

currentUID=user.uid;
userEmail.textContent=user.email;

await checkPin();
loadBalance();
loadTransactions();

});

/* BALANCE */
async function loadBalance(){
const ref=doc(db,"users",currentUID);
const snap=await getDoc(ref);
balanceEl.textContent=snap.data().balance||0;
}

/* ADD MONEY */
addBtn.onclick=async()=>{

const amount=Number(addAmount.value);
if(amount<=0)return alert("Invalid amount");

const ref=doc(db,"users",currentUID);
const snap=await getDoc(ref);

await updateDoc(ref,{
balance:(snap.data().balance||0)+amount
});

await addDoc(collection(db,"transactions"),{
type:"receive",
amount,
userId:currentUID,
createdAt:serverTimestamp()
});

loadBalance();
loadTransactions();
};

/* SEND MONEY */
sendBtn.onclick=async()=>{

const amount=Number(sendAmount.value);
const email=receiverEmail.value;

const senderRef=doc(db,"users",currentUID);
const senderSnap=await getDoc(senderRef);

if(senderSnap.data().balance<amount)
return alert("Insufficient balance");

const q=query(
collection(db,"users"),
where("email","==",email)
);

const qs=await getDocs(q);
if(qs.empty)return alert("Receiver not found");

const receiverDoc=qs.docs[0];

await updateDoc(senderRef,{
balance:senderSnap.data().balance-amount
});

await updateDoc(
doc(db,"users",receiverDoc.id),
{balance:receiverDoc.data().balance+amount}
);

/* Transactions */
await addDoc(collection(db,"transactions"),{
type:"send",
amount,
userId:currentUID,
createdAt:serverTimestamp()
});

await addDoc(collection(db,"transactions"),{
type:"receive",
amount,
userId:receiverDoc.id,
createdAt:serverTimestamp()
});

loadBalance();
loadTransactions();
};

/* HISTORY */
async function loadTransactions(){

const txList=document.getElementById("txList");

const q=query(
collection(db,"transactions"),
where("userId","==",currentUID),
orderBy("createdAt","desc")
);

const snap=await getDocs(q);

txList.innerHTML="";

snap.forEach(doc=>{
const tx=doc.data();
const sign=tx.type==="send"?"âˆ’":"+";

txList.innerHTML+=`
<li>
<strong>${sign} KSh ${tx.amount}</strong><br>
<small>${tx.type}</small>
</li>`;
});

}

/* PIN CHECK */
async function checkPin(){

const ref=doc(db,"users",currentUID);
const snap=await getDoc(ref);

if(!snap.data().pin){

let newPin=prompt("Create 4-digit PIN");

if(!newPin||newPin.length!==4){
alert("PIN must be 4 digits");
return checkPin();
}

await updateDoc(ref,{pin:newPin});
alert("PIN created");
}

pinLock.style.display="flex";
}

/* UNLOCK */
unlockBtn.onclick=async()=>{

const ref=doc(db,"users",currentUID);
const snap=await getDoc(ref);

if(pinInput.value===snap.data().pin){
pinLock.style.display="none";
}else{
alert("Wrong PIN");
}

};

/* LOGOUT */
logoutBtn.onclick=async()=>{
await signOut(auth);
window.location="login.html";
};

</script>
</body>
</html>
